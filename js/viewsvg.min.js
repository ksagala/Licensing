function readFilterValuesfromSvg(){const e=SvgModule.Data.Tag.style.filter,t=e.indexOf("brightness"),n=e.indexOf("contrast"),a=e.indexOf("hue-rotate"),o=e.indexOf("saturate"),i=Common.getStringBetween(e,t,"(",")"),l=Common.getStringBetween(e,n,"(",")"),s=Common.getStringBetween(e,a,"(","deg"),r=Common.getStringBetween(e,o,"(",")");i&&(PageData.Controls.Brightness.value=10*i),l&&(PageData.Controls.Contrast.value=10*l),s&&(PageData.Controls.Hue.value=s),r&&(PageData.Controls.Saturation.value=10*r)}function filterChange(){SvgModule.Data.Tag.style.filter=Common.getFiltersCss(PageData.Controls.Brightness.value,PageData.Controls.Contrast.value,PageData.Controls.Hue.value,PageData.Controls.Saturation.value)}function filterResetClick(){PageData.Controls.Brightness.value=PageData.Controls.Brightness.defaultValue,PageData.Controls.Contrast.value=PageData.Controls.Contrast.defaultValue,PageData.Controls.Hue.value=PageData.Controls.Hue.defaultValue,PageData.Controls.Saturation.value=PageData.Controls.Saturation.defaultValue,filterChange()}function filterSaveClick(){Common.Settings.Filters.Brightness=PageData.Controls.Brightness.value,Common.Settings.Filters.Contrast=PageData.Controls.Contrast.value,Common.Settings.Filters.Hue=PageData.Controls.Hue.value,Common.Settings.Filters.Saturation=PageData.Controls.Saturation.value,Common.saveSettings(),PageData.ControlsOpen=!1,setControlsPosition()}function setControlsPosition(){if(Common.isIE)return;const e=document.getElementById("imageControls");e.style.top=PageData.ControlsOpen?"24px":"-300px",e.style.display="block"}function setupImageControls(){Common.isIE||(PageData.Controls.Brightness=document.getElementById("brightness"),PageData.Controls.Contrast=document.getElementById("contrast"),PageData.Controls.Hue=document.getElementById("hue"),PageData.Controls.Saturation=document.getElementById("saturation"),PageData.Controls.Brightness.value=Common.Settings.Filters.Brightness,PageData.Controls.Contrast.value=Common.Settings.Filters.Contrast,PageData.Controls.Hue.value=Common.Settings.Filters.Hue,PageData.Controls.Saturation.value=Common.Settings.Filters.Saturation,PageData.Controls.Brightness.addEventListener("input",filterChange),PageData.Controls.Contrast.addEventListener("input",filterChange),PageData.Controls.Hue.addEventListener("input",filterChange),PageData.Controls.Saturation.addEventListener("input",filterChange),document.getElementById("reset").addEventListener("click",filterResetClick),document.getElementById("save").addEventListener("click",filterSaveClick))}function showError(e){document.title="Error | M365 Maps",document.getElementById("errorMessage").innerText=e,document.getElementById("errorDiv").style.display="block",document.getElementById("menu").style.display="none",SvgModule.Data.Tag&&(SvgModule.Data.Tag.style.display="none")}function updateMenu(){const e=document.getElementById("menu"),t=document.getElementById("menuGrip"),n=document.getElementById("menuSave"),a=document.getElementById("menuHighlight"),o=document.getElementById("menuExportSvg"),i=document.getElementById("menuExportPng");if(Common.isIOSEdge){const e=document.getElementById("menuPrint");e.style.display="none"}SvgModule.Data.Highlighting?(a.src="/media/edit-on.svg",a.title="Turn off highlighter"):(a.src="/media/edit-off.svg",a.title="Turn on highlighter"),SvgModule.Data.Highlighting?(n.style.display="inline",o.style.display=Common.isIOSEdge?"none":"inline",i.style.display=Common.isIOSEdge||Common.isIE?"none":"inline"):(n.style.display="none",o.style.display=Common.isIOSEdge?"none":"inline",i.style.display=Common.isIE||Common.isIOSEdge?"none":"inline"),e.style.display="block",PageData.MenuOffset=e.clientWidth-t.clientWidth-4}function appOffline(){document.getElementById("offline").style.display="block",updateMenu()}function appOnline(){document.getElementById("offline").style.display="none",updateMenu()}function setMenuPosition(){const e=document.getElementById("menu"),t=document.getElementById("menuGrip");PageData.MenuOpen?(t.title="Close menu",t.src="/media/close.svg",e.style.right=0):(t.title="Open menu",t.src="/media/open.svg",e.style.right=-PageData.MenuOffset+"px")}function menuGripClick(){PageData.MenuOpen=!PageData.MenuOpen,setMenuPosition(),!PageData.MenuOpen&&PageData.ControlsOpen&&(PageData.ControlsOpen=!1,setControlsPosition())}function printClick(e){e.preventDefault(),window.print()}function menuHighlightClick(e){e.preventDefault(),SvgModule.Data.Highlighting=!SvgModule.Data.Highlighting,updateMenu()}function menuControlsClick(e){e.preventDefault(),PageData.ControlsOpen=!PageData.ControlsOpen,setControlsPosition()}function menuSaveClick(e){e.preventDefault();let t=PageData.SavedImageTitle,n=Date.now().toString(),a=Common.customConfirm("Overwrite existing diagram?");if(a)n=PageData.Filename;else if(t=Common.customPrompt("Save diagram as:",t),!t)return;const o=SvgModule.getSvgXml(),i={Title:t,SvgXml:o},l=JSON.stringify(i);localStorage.setItem(n,l)}function exportSvgClick(e){e.preventDefault();const t=PageData.SavedImageTitle+".svg",n=SvgModule.getSvgXml();Common.exportSvg(t,n)}function exportPngClick(e){if(e.preventDefault(),Common.isIE)return;const t=window.getComputedStyle(document.body).backgroundColor,n=PageData.SavedImageTitle+".png",a=SvgModule.getSvgXml();Common.exportPng(n,a,t)}function setupMenu(){document.getElementById("menuGrip").addEventListener("click",menuGripClick),document.getElementById("menuPrint").addEventListener("click",printClick),document.getElementById("menuHighlight").addEventListener("click",menuHighlightClick);const e=document.getElementById("menuControls");Common.isIE?e.style.display="none":e.addEventListener("click",menuControlsClick),document.getElementById("menuSave").addEventListener("click",menuSaveClick),document.getElementById("menuExportSvg").addEventListener("click",exportSvgClick),document.getElementById("menuExportPng").addEventListener("click",exportPngClick),PageData.MenuOpen="Open"===Common.Settings.Menu}function legacyRedirect(){let e=window.location.href.indexOf("#");if(-1===e&&(e=window.location.href.indexOf("=")),-1===e||e===window.location.href.length-1)return;if("*"===window.location.href[e+1])return;const t=window.location.origin+"/"+window.location.href.substring(e+1)+".htm";location.replace(t)}function loadSavedDiagram(){if(!window.location.hash)return void showError("Missing saved diagram details");const e=window.location.hash.indexOf("-blank");PageData.Filename=-1!==e?window.location.hash.substring(2,e):window.location.hash.substring(2);const t=localStorage.getItem(PageData.Filename);if(!t)return void showError("Failed to load saved diagram");const n=JSON.parse(t);if(!n||!n.SvgXml)return void showError("Failed to process saved diagram data");PageData.SavedImageTitle=n.Title,document.title="Saved diagram: "+PageData.SavedImageTitle+" | M365 Maps";const a=n.SvgXml.replace(/<!--.*-->/i,"").replace(/<\?xml.*\?>/i,"").replace(/<!doctype.*>/i,"").replace(/^[\n\r]+/,"");SvgModule.Data.Tag=Common.createElementFromHtml(a),document.body.appendChild(SvgModule.Data.Tag),SvgModule.injectHighlightStyles(),SvgModule.sizeSvg(),SvgModule.registerEvents(),""!==SvgModule.Data.Tag.style.filter&&readFilterValuesfromSvg(),filterChange()}function pageLoad(){const e=window.location.hash.endsWith("-blank");e||setupMenu(),setupImageControls(),loadSavedDiagram(),e||(updateMenu(),setMenuPosition(),setControlsPosition(),document.getElementById("offline").style.display=navigator.onLine?"none":"block",window.addEventListener("offline",appOffline),window.addEventListener("online",appOnline))}const PageData={Controls:{Brightness:null,Contrast:null,Hue:null,Saturation:null},ControlsOpen:!1,Filename:"",MenuOffset:0,MenuOpen:!1,SavedImageTitle:"untitled"};legacyRedirect(),window.addEventListener("load",pageLoad);