function getSvgXml(){return(new XMLSerializer).serializeToString(SvgData.Tag)}function injectHighlightStyles(){const e=SvgData.Tag.getElementById("m365MapsHighlights");e&&SvgData.Tag.removeChild(e);const t='<style id="m365MapsHighlights">.highlight1{fill:'+Settings.Highlight1+"!important;transition:0.4s;}.highlight2{fill:"+Settings.Highlight2+"!important;transition:0.4s;}.highlight3{fill:"+Settings.Highlight3+"!important;transition:0.4s;}</style>",a=createElementFromHtml(t);SvgData.Tag.appendChild(a)}function clearAllHighlights(){Array.from(SvgData.Tag.getElementsByClassName("highlight1")).forEach(function(e){e.classList.remove("highlight1")}),Array.from(SvgData.Tag.getElementsByClassName("highlight2")).forEach(function(e){e.classList.remove("highlight2")}),Array.from(SvgData.Tag.getElementsByClassName("highlight3")).forEach(function(e){e.classList.remove("highlight3")})}function findHighlightTarget(e){let t=e;if("tspan"===t.nodeName&&(t=t.parentNode),"text"===t.nodeName&&(t=t.parentNode),"g"===t.nodeName){let e=t.getElementsByTagName("rect");if(0===e.length&&(e=t.getElementsByTagName("path")),0===e.length)return null;t=e.item(0)}return"rect"===t.nodeName||"path"===t.nodeName?t:null}function sizeSvg(){if(!SvgData.Tag)return;SvgData.Tag.style.display="inline";let e=.985;switch(Settings.Zoom){case"Fit":e*=Math.min(window.innerWidth/SvgData.Tag.clientWidth,window.innerHeight/SvgData.Tag.clientHeight);break;case"Fit Width":e*=window.innerWidth/SvgData.Tag.clientWidth;break;case"Fit Height":e*=window.innerHeight/SvgData.Tag.clientHeight;break;case"Fill":e*=Math.max(window.innerWidth/SvgData.Tag.clientWidth,window.innerHeight/SvgData.Tag.clientHeight);break;default:throw"Unexpected Zoom setting value: "+Settings.Zoom}const t=Math.floor(SvgData.Tag.clientWidth*e),a=Math.floor(SvgData.Tag.clientHeight*e);SvgData.Tag.style.width=t+"px",SvgData.Tag.style.height=a+"px",SvgData.StartWidth=t,SvgData.StartHeight=a,SvgData.Zoom=100}function auxClickEvent(e){e.button===Mouse.Button.Middle&&(e.preventDefault(),SvgData.Editing?clearAllHighlights():sizeSvg())}function clickEvent(e){if(SvgData.Dragging)e.preventDefault(),SvgData.Dragging=!1;else if(SvgData.Editing){const t=findHighlightTarget(e.target);if(null===t)return;e.preventDefault(),t.classList.contains("highlight1")?t.classList.remove("highlight1"):t.classList.contains("highlight2")?t.classList.remove("highlight2"):t.classList.contains("highlight3")?t.classList.remove("highlight3"):e.ctrlKey?t.classList.add("highlight3"):e.shiftKey?t.classList.add("highlight2"):t.classList.add("highlight1")}}function mouseDown(e){e.buttons===Mouse.Buttons.Left?(SvgData.Scroll.TargetNodeName=e.target.nodeName,SvgData.Scroll.Left=document.documentElement.scrollLeft,SvgData.Scroll.Top=document.documentElement.scrollTop,SvgData.Scroll.X=e.clientX,SvgData.Scroll.Y=e.clientY):e.buttons===Mouse.Buttons.Middle&&e.preventDefault()}function mouseMove(e){e.buttons===Mouse.Buttons.Left&&"INPUT"!==SvgData.Scroll.TargetNodeName&&"BUTTON"!==SvgData.Scroll.TargetNodeName&&(SvgData.Scroll.X===e.clientX&&SvgData.Scroll.Y===e.clientY||(e.preventDefault(),SvgData.Dragging=!0,window.scroll(SvgData.Scroll.Left+SvgData.Scroll.X-e.clientX,SvgData.Scroll.Top+SvgData.Scroll.Y-e.clientY)))}function zoomTimer(){if(!SvgData.Zooming)return;SvgData.Zooming=!1;const e=SvgData.Tag.clientWidth,t=SvgData.Tag.clientHeight,a=Math.floor(SvgData.StartWidth*SvgData.Zoom/100),n=Math.floor(SvgData.StartHeight*SvgData.Zoom/100);SvgData.Tag.style.width=a+"px",SvgData.Tag.style.height=n+"px";const o=a/e,i=n/t,l=SvgData.ZoomX*o,g=SvgData.ZoomY*i,s=l-SvgData.ZoomX,r=g-SvgData.ZoomY;window.scroll(document.documentElement.scrollLeft+s,document.documentElement.scrollTop+r)}function applyZoomStep(e){SvgData.Zoom<100?e/=4:100===SvgData.Zoom&&e<0&&(e/=4),SvgData.Zoom+=e,SvgData.Zoom>1e3?SvgData.Zoom=1e3:SvgData.Zoom<10&&(SvgData.Zoom=10)}function wheelEvent(e){if(!SvgData.Tag)return;if(e.preventDefault(),e.deltaY<.1&&e.deltaY>-.1)return;let t=SvgData.ZoomStepSize;e.deltaY>0&&(t=-t),applyZoomStep(t),SvgData.ZoomX=e.pageX,SvgData.ZoomY=e.pageY,SvgData.Zooming=!0}function zoomKey(e){applyZoomStep(e),SvgData.ZoomX=document.documentElement.scrollLeft+window.innerWidth/2,SvgData.ZoomY=document.documentElement.scrollTop+window.innerHeight/2,SvgData.Zooming=!0}function keyUpEvent(e){if(e.target===document.body)switch(e.key){case"+":zoomKey(SvgData.ZoomStepSize),e.preventDefault();break;case"-":zoomKey(-SvgData.ZoomStepSize),e.preventDefault();break;case"=":sizeSvg(),e.preventDefault()}}function registerSvgEvents(){SvgData.Tag.addEventListener("click",clickEvent),SvgData.Tag.addEventListener("auxclick",auxClickEvent),window.addEventListener("mousedown",mouseDown),window.addEventListener("mousemove",mouseMove),window.addEventListener("keyup",keyUpEvent),window.addEventListener("wheel",wheelEvent,{passive:!1}),setInterval(zoomTimer,100)}function flagClick(){if(PageData.Flagged){const e=PageData.Flags.indexOf(PageData.Filename);e>-1&&PageData.Flags.splice(e,1),PageData.Flagged=!1}else PageData.Flags.push(PageData.Filename),PageData.Flagged=!0;localStorage.setItem(StoreName.Flags,JSON.stringify(PageData.Flags)),updateMenu()}function loadFlags(){const e=localStorage.getItem(StoreName.Flags);if(e){const t=JSON.parse(e);t&&(PageData.Flags=t)}}function readFilterValuesfromSvg(){const e=SvgData.Tag.style.filter;if(""===e)return!1;const t=e.indexOf("brightness"),a=e.indexOf("contrast"),n=e.indexOf("hue-rotate"),o=e.indexOf("saturate"),i=getStringBetween(e,t,"(",")"),l=getStringBetween(e,a,"(",")"),g=getStringBetween(e,n,"(","deg"),s=getStringBetween(e,o,"(",")");return i&&(PageData.Controls.Brightness.value=10*i),l&&(PageData.Controls.Contrast.value=10*l),g&&(PageData.Controls.Hue.value=g),s&&(PageData.Controls.Saturation.value=10*s),!0}function filterChange(){SvgData.Tag.style.filter=getFiltersCss(PageData.Controls.Brightness.value,PageData.Controls.Contrast.value,PageData.Controls.Hue.value,PageData.Controls.Saturation.value)}function imageControlsResetClick(){PageData.Controls.Brightness.value=PageData.Controls.Brightness.defaultValue,PageData.Controls.Contrast.value=PageData.Controls.Contrast.defaultValue,PageData.Controls.Hue.value=PageData.Controls.Hue.defaultValue,PageData.Controls.Saturation.value=PageData.Controls.Saturation.defaultValue,filterChange()}function imageControlsSaveClick(){Settings.Filters.Brightness=PageData.Controls.Brightness.value,Settings.Filters.Contrast=PageData.Controls.Contrast.value,Settings.Filters.Hue=PageData.Controls.Hue.value,Settings.Filters.Saturation=PageData.Controls.Saturation.value,saveSettings(),PageData.ControlsOpen=!1,setControlsPosition()}function setControlsPosition(){const e=document.getElementById("image-controls");e.style.top=(PageData.ControlsOpen?document.getElementById("menu").clientHeight:"-"+e.clientHeight)+"px"}function setupImageControls(){PageData.Controls.Brightness=document.getElementById("brightness"),PageData.Controls.Contrast=document.getElementById("contrast"),PageData.Controls.Hue=document.getElementById("hue"),PageData.Controls.Saturation=document.getElementById("saturation"),PageData.Controls.Brightness.value=Settings.Filters.Brightness,PageData.Controls.Contrast.value=Settings.Filters.Contrast,PageData.Controls.Hue.value=Settings.Filters.Hue,PageData.Controls.Saturation.value=Settings.Filters.Saturation,PageData.Controls.Brightness.addEventListener("input",filterChange),PageData.Controls.Contrast.addEventListener("input",filterChange),PageData.Controls.Hue.addEventListener("input",filterChange),PageData.Controls.Saturation.addEventListener("input",filterChange),document.getElementById("image-controls-reset").addEventListener("click",imageControlsResetClick),document.getElementById("image-controls-save").addEventListener("click",imageControlsSaveClick)}function updateMenu(){const e=document.getElementById("menu"),t=document.getElementById("menu-grip"),a=document.getElementById("menu-edit"),n=document.getElementById("menu-flag"),o=document.getElementById("menu-download-pdf"),i=document.getElementById("menu-download-png"),l=document.getElementById("menu-export-svg"),g=document.getElementById("menu-export-png");isIOSEdge&&(document.getElementById("menu-print").style.display="none",PageData.SavedDiagram&&(l.style.display="none",g.style.display="none")),SvgData.Editing?(a.className="on",a.title="Turn off edit mode",PageData.SavedDiagram||(l.style.display=isIOSEdge?"none":"inline",g.style.display=isIOSEdge?"none":"inline"),o&&(o.style.display="none"),i&&(i.style.display="none")):(a.className="off",a.title="Turn on edit mode",PageData.SavedDiagram||(l.style.display="none",g.style.display="none"),o&&(o.style.display="inline"),i&&(i.style.display="inline"),navigator.onLine?(o&&(o.disabled=!1),i&&(i.disabled=!1)):(o&&(o.disabled=!0),i&&(i.disabled=!0))),n&&(PageData.Flagged?(n.className="flagged",n.title="Remove flag"):(n.className="unflagged",n.title="Flag this diagram")),PageData.MenuOffset=e.clientWidth-window.getComputedStyle(e).paddingLeft.slice(0,-2)-t.clientWidth-window.getComputedStyle(t).marginRight.slice(0,-2)}function setMenuPosition(){const e=document.getElementById("menu"),t=document.getElementById("menu-grip");PageData.MenuOpen?(t.title="Close menu",t.className="close",e.style.right=0):(t.title="Open menu",t.className="open",e.style.right=-PageData.MenuOffset+"px")}function menuGripClick(){PageData.MenuOpen=!PageData.MenuOpen,setMenuPosition(),!PageData.MenuOpen&&PageData.ControlsOpen&&(PageData.ControlsOpen=!1,setControlsPosition())}function menuEditClick(){SvgData.Editing=!SvgData.Editing,updateMenu()}function menuControlsClick(){PageData.ControlsOpen=!PageData.ControlsOpen,setControlsPosition()}function saveSvg(e,t){const a=getSvgXml(),n={Title:e,SvgXml:a},o=JSON.stringify(n);localStorage.setItem(t,o)}function saveOK(){const e=getModalInputText();if(!e)return;const t=Date.now().toString();saveSvg(e,t),window.location.href="/viewsvg.htm#*"+t}function overwriteYes(){saveSvg(PageData.SavedImageTitle,PageData.Filename)}function overwriteNo(){modalPrompt("Save diagram as:",PageData.SavedImageTitle,saveOK)}function menuSaveClick(){if(PageData.SavedDiagram)modalConfirm("Overwrite existing diagram?",overwriteYes,overwriteNo);else{const e=decodeURIComponent(PageData.Filename);modalPrompt("Save diagram as:",e,saveOK)}}function exportSvgClick(){var e;e=PageData.SavedDiagram?PageData.SavedImageTitle+".svg":decodeURIComponent(PageData.Filename)+".svg";const t=getSvgXml();exportSvg(e,t)}function exportPngClick(){var e;e=PageData.SavedDiagram?PageData.SavedImageTitle+".png":decodeURIComponent(PageData.Filename)+".png";const t=getSvgXml(),a=window.getComputedStyle(document.body).backgroundColor;exportPng(e,t,a)}function setupMenu(){document.getElementById("menu-grip").addEventListener("click",menuGripClick),document.getElementById("menu-back").addEventListener("click",()=>window.history.back()),document.getElementById("menu-print").addEventListener("click",()=>window.print()),document.getElementById("menu-edit").addEventListener("click",menuEditClick),document.getElementById("menu-controls").addEventListener("click",menuControlsClick),document.getElementById("menu-save").addEventListener("click",menuSaveClick),document.getElementById("menu-export-svg").addEventListener("click",exportSvgClick),document.getElementById("menu-export-png").addEventListener("click",exportPngClick);const e=document.getElementById("menu-flag");e&&e.addEventListener("click",flagClick);const t=document.getElementById("menu-download-pdf");t&&t.addEventListener("click",()=>document.getElementById("download-pdf").click());const a=document.getElementById("menu-download-png");a&&a.addEventListener("click",()=>document.getElementById("download-png").click()),PageData.MenuOpen="Open"===Settings.Menu}function legacyRedirect(){let e=window.location.href.indexOf("#");if(-1===e&&(e=window.location.href.indexOf("=")),-1===e||e===window.location.href.length-1)return!1;if("*"===window.location.href[e+1])return!1;const t=window.location.origin+"/"+window.location.href.substring(e+1)+".htm";return location.replace(t),!0}function loadSavedDiagram(){if(!window.location.hash||window.location.hash.length<=2)return modalAlert("Missing saved diagram details",PageData.Comparing?void 0:()=>window.history.back()),!1;PageData.Comparing?PageData.Filename=window.location.hash.slice(2,-8):PageData.Filename=window.location.hash.substring(2);const e=localStorage.getItem(PageData.Filename);if(!e)return modalAlert("Failed to locate saved diagram",PageData.Comparing?void 0:()=>window.history.back()),!1;const t=JSON.parse(e);if(!t||!t.SvgXml)return modalAlert("Failed to process saved diagram data",PageData.Comparing?void 0:()=>window.history.back()),!1;PageData.SavedImageTitle=t.Title,document.title=`Saved Diagram: ${t.Title} | M365 Maps`;const a=t.SvgXml.replace(/<!--.*-->/i,"").replace(/<\?xml.*\?>/i,"").replace(/<!doctype.*>/i,"").replace(/^[\n\r]+/,"");return SvgData.Tag=createElementFromHtml(a),document.body.appendChild(SvgData.Tag),!0}function DOMContentLoaded(){setupModal(),PageData.Comparing?(document.body.style.overflow="hidden",document.getElementById("menu").style.display="none",document.getElementById("image-controls").style.display="none"):(setupMenu(),setupOfflineIndicator(),window.addEventListener("offline",updateMenu),window.addEventListener("online",updateMenu),PageData.SavedDiagram||(loadFlags(),PageData.Filename=window.location.pathname.slice(1,-4),PageData.Flagged=PageData.Flags.includes(PageData.Filename))),setupImageControls()}function pageLoad(){if(PageData.SavedDiagram){const e=loadSavedDiagram();if(!e)return}else SvgData.Tag=document.getElementsByTagName("svg").item(0);injectHighlightStyles(),sizeSvg(),registerSvgEvents();const e=readFilterValuesfromSvg();e||filterChange(),PageData.Comparing||(updateMenu(),setMenuPosition(),setControlsPosition())}const SvgData={Dragging:!1,Editing:!1,Scroll:{TargetNodeName:void 0,Top:0,Left:0,X:0,Y:0},StartWidth:0,StartHeight:0,Tag:void 0,Zoom:100,ZoomX:0,ZoomY:0,Zooming:!1,ZoomStepSize:20},PageData={Controls:{Brightness:null,Contrast:null,Hue:null,Saturation:null},ControlsOpen:!1,Filename:"",MenuOffset:0,MenuOpen:!1,SavedImageTitle:"untitled",Flagged:!1,Flags:[],SavedDiagram:!1,Comparing:!1};PageData.Comparing=window.location.hash.endsWith("/compare"),PageData.SavedDiagram="/viewsvg.htm"===window.location.pathname;let redirecting=!1;PageData.SavedDiagram&&(redirecting=legacyRedirect()),redirecting||(document.addEventListener("DOMContentLoaded",DOMContentLoaded),window.addEventListener("load",pageLoad));